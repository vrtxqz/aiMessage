<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LiteOpt Chat - iMessage Style</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:#000;
      color:#fff;
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    header {
      background:#1c1c1e;
      padding:10px 16px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #333;
      position:relative;
    }
    .back { color:#007aff; font-size:20px; margin-right:12px; cursor:pointer; }
    .name { flex:1; text-align:center; font-weight:600; font-size:18px; }
    #chat {
      flex:1;
      overflow-y:auto;
      padding:16px;
      background:#000;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .msg-container {
      display:flex;
      align-items:flex-end;
      max-width:80%;
      margin-bottom:4px;
    }
    .msg-container.user { flex-direction:row-reverse; align-self:flex-end; }
    .msg-container.ai { align-self:flex-start; }
    .avatar {
      width:32px;
      height:32px;
      border-radius:50%;
      margin:0 8px;
      background:#333;
      flex-shrink:0;
      object-fit:cover;
    }
    .msg {
      padding:10px 14px;
      border-radius:18px;
      font-size:15px;
      line-height:1.3;
      position:relative;
      word-wrap:break-word;
    }
    .user .msg {
      background:#007aff;
      color:#fff;
      border-bottom-right-radius:4px;
    }
    .ai .msg {
      background:#1c1c1e;
      color:#fff;
      border-bottom-left-radius:4px;
    }
    .time {
      font-size:11px;
      color:#888;
      margin-top:4px;
      text-align:right;
      align-self:flex-end;
    }
    .typing {
      align-self:flex-start;
      padding:10px 14px;
      background:#1c1c1e;
      border-radius:18px;
      width:fit-content;
      font-size:14px;
      color:#888;
    }
    #input-area {
      background:#1c1c1e;
      padding:10px 16px;
      display:flex;
      align-items:center;
      border-top:1px solid #333;
    }
    #input {
      flex:1;
      background:#2c2c2e;
      border:none;
      border-radius:20px;
      padding:12px 16px;
      color:#fff;
      font-size:16px;
      outline:none;
    }
    #send {
      background:#007aff;
      color:#fff;
      border:none;
      border-radius:50%;
      width:38px;
      height:38px;
      margin-left:12px;
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #settings-btn {
      position: absolute;
      top: 10px;
      right: 60px;
      padding: 8px 12px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
    }
    #settings-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items:center;
      justify-content:center;
      z-index: 100;
    }
    .settings-content {
      background: #1c1c1e;
      padding: 20px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .settings-content input, .settings-content textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #444;
      background: #2c2c2e;
      color: white;
    }
    .settings-content button {
      padding: 10px 20px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>
    <div class="back"><</div>
    <div class="name">LiteOpt Chat</div>
    <button id="settings-btn">Settings</button>
  </header>

  <div id="chat"></div>

  <div id="input-area">
    <input id="input" type="text" placeholder="iMessage..." autocomplete="off"/>
    <button id="send">‚û§</button>
  </div>

  <!-- Settings Panel -->
  <div id="settings-panel">
    <div class="settings-content">
      <h2>AI Settings</h2>
      <label>T√™n AI:</label>
      <input type="text" id="ai-name" placeholder="LiteOpt AI" value="LiteOpt AI"/>

      <label>T√≠nh c√°ch AI (prompt):</label>
      <textarea id="ai-personality" rows="4" placeholder="B·∫°n l√† m·ªôt ng∆∞·ªùi b·∫°n th√¢n thi·∫øt, vui t√≠nh, hay d√πng emoji..."></textarea>

      <label>Avatar AI:</label>
      <input type="file" id="avatar-input" accept="image/*"/>

      <button id="save-settings">L∆∞u</button>
      <button id="close-settings">ƒê√≥ng</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const closeSettings = document.getElementById('close-settings');
    const saveSettings = document.getElementById('save-settings');
    const aiNameInput = document.getElementById('ai-name');
    const aiPersonalityInput = document.getElementById('ai-personality');
    const avatarInput = document.getElementById('avatar-input');

    // API config (thay b·∫±ng c·ªßa b·∫°n)
    const API_KEY = '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'; // D√ÅN KEY TH·∫¨T V√ÄO ƒê√ÇY
    const API_URL = 'https://api.openrouter.ai/api/v1/chat/completions';
    const MODEL = 'openai/gpt-oss-safeguard-20b';

    // Load settings t·ª´ localStorage
    let aiName = localStorage.getItem('aiName') || 'LiteOpt AI';
    let aiPersonality = localStorage.getItem('aiPersonality') || 'B·∫°n l√† m·ªôt ng∆∞·ªùi b·∫°n th√¢n thi·∫øt, vui t√≠nh, hay d√πng emoji, n√≥i chuy·ªán t·ª± nhi√™n nh∆∞ bro, lu√¥n h·ªó tr·ª£ v√† hi·ªÉu t√¢m tr·∫°ng c·ªßa ng∆∞·ªùi d√πng. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, ng·∫Øn g·ªçn, g·∫ßn g≈©i.';
    let aiAvatar = localStorage.getItem('aiAvatar') || 'https://via.placeholder.com/32/1c1c1e/fff?text=AI';

    aiNameInput.value = aiName;
    aiPersonalityInput.value = aiPersonality;

    // L∆∞u l·ªãch s·ª≠ chat (memory cao, kh√¥ng gi·ªõi h·∫°n)
    let messages = JSON.parse(localStorage.getItem('chatHistory')) || [
      { role: 'assistant', content: `Yo bro, ch√†o m·ª´ng ƒë·∫øn v·ªõi ${aiName}! H√¥m nay kh·ªèe kh√¥ng? üòé` }
    ];

    // Hi·ªÉn th·ªã l·ªãch s·ª≠ c≈©
    function loadHistory() {
      chat.innerHTML = '';
      messages.forEach(msg => addMessage(msg.role, msg.content, true));
      chat.scrollTop = chat.scrollHeight;
    }

    function addMessage(role, content, isHistory = false) {
      const container = document.createElement('div');
      container.className = `msg-container ${role === 'user' ? 'user' : 'ai'}`;

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'avatar';
      const img = document.createElement('img');
      img.src = role === 'user' ? 'https://via.placeholder.com/32/007aff/fff?text=You' : aiAvatar;
      img.alt = role === 'user' ? 'You' : aiName;
      avatarDiv.appendChild(img);

      const bubble = document.createElement('div');
      bubble.className = 'msg';
      bubble.textContent = content;

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      container.appendChild(avatarDiv);
      container.appendChild(bubble);
      container.appendChild(time);

      chat.appendChild(container);
      if (!isHistory) chat.scrollTop = chat.scrollHeight;
    }

    loadHistory();

    async function sendMsg() {
      const text = input.value.trim();
      if (!text) return;

      addMessage('user', text);
      messages.push({ role: 'user', content: text });
      input.value = '';

      const typingContainer = document.createElement('div');
      typingContainer.className = 'msg-container ai';
      const typingAvatar = document.createElement('div');
      typingAvatar.className = 'avatar';
      const typingImg = document.createElement('img');
      typingImg.src = aiAvatar;
      typingAvatar.appendChild(typingImg);
      const typingBubble = document.createElement('div');
      typingBubble.className = 'msg typing';
      typingBubble.innerHTML = 'ƒêang so·∫°n <span class="typing-dots">...</span>';
      typingContainer.appendChild(typingAvatar);
      typingContainer.appendChild(typingBubble);
      chat.appendChild(typingContainer);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json',
            'HTTP-Referer': window.location.href,
            'X-Title': 'LiteOpt Chat'
          },
          body: JSON.stringify({
            model: MODEL,
            messages: [
              { role: 'system', content: `T√™n b·∫°n l√† ${aiName}. T√≠nh c√°ch: ${aiPersonality}` },
              ...messages
            ],
            temperature: 0.7,
            max_tokens: 1024
          })
        });

        if (!res.ok) throw new Error('API error: ' + res.status);

        const data = await res.json();
        if (!data.choices || !data.choices[0]) throw new Error('No response from API');

        const reply = data.choices[0].message.content.trim();

        typingContainer.remove();
        addMessage('assistant', reply);
        messages.push({ role: 'assistant', content: reply });

        localStorage.setItem('chatHistory', JSON.stringify(messages));
      } catch (err) {
        typingContainer.remove();
        addMessage('assistant', 'L·ªói r·ªìi bro: ' + err.message);
        console.error(err);
      }
    }

    sendBtn.onclick = sendMsg;
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMsg();
    });

    // Settings panel
    settingsBtn.onclick = () => settingsPanel.style.display = 'flex';
    closeSettings.onclick = () => settingsPanel.style.display = 'none';

    saveSettings.onclick = () => {
      aiName = aiNameInput.value.trim() || 'LiteOpt AI';
      aiPersonality = aiPersonalityInput.value.trim() || 'B·∫°n l√† m·ªôt ng∆∞·ªùi b·∫°n th√¢n thi·∫øt, vui t√≠nh, hay d√πng emoji...';
      localStorage.setItem('aiName', aiName);
      localStorage.setItem('aiPersonality', aiPersonality);
      settingsPanel.style.display = 'none';
      loadHistory(); // reload ƒë·ªÉ c·∫≠p nh·∫≠t t√™n n·∫øu c·∫ßn
    };

    // Upload avatar
    uploadAvatar.onclick = () => avatarInput.click();
    avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = event => {
        aiAvatar = event.target.result;
        localStorage.setItem('aiAvatar', aiAvatar);
        loadHistory(); // reload ƒë·ªÉ c·∫≠p nh·∫≠t avatar m·ªõi
      };
      reader.readAsDataURL(file);
    });

    // N√∫t x√≥a l·ªãch s·ª≠
    const resetBtn = document.createElement('button');
    resetBtn.textContent = 'X√≥a l·ªãch s·ª≠';
    resetBtn.style.position = 'absolute';
    resetBtn.style.top = '10px';
    resetBtn.style.right = '10px';
    resetBtn.style.padding = '8px 16px';
    resetBtn.style.background = '#ff3b30';
    resetBtn.style.color = '#fff';
    resetBtn.style.border = 'none';
    resetBtn.style.borderRadius = '8px';
    resetBtn.style.cursor = 'pointer';
    document.body.appendChild(resetBtn);
    resetBtn.onclick = () => {
      localStorage.removeItem('chatHistory');
      localStorage.removeItem('aiAvatar');
      aiAvatar = 'https://via.placeholder.com/32/1c1c1e/fff?text=AI';
      messages = [{ role: 'assistant', content: 'L·ªãch s·ª≠ ƒë√£ x√≥a. Ch√†o bro!' }];
      loadHistory();
    };
  </script>
</body>
</html>
