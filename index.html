<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LiteOpt Chat - iMessage Style</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:#000;
      color:#fff;
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    header {
      background:#1c1c1e;
      padding:10px 16px;
      display:flex;
      align-items:center;
      border-bottom:1px solid #333;
      position:relative;
    }
    .back { color:#007aff; font-size:20px; margin-right:12px; cursor:pointer; }
    .name { flex:1; text-align:center; font-weight:600; font-size:18px; }
    #chat {
      flex:1;
      overflow-y:auto;
      padding:16px;
      background:#000;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .msg-container {
      display:flex;
      align-items:flex-end;
      max-width:80%;
      margin-bottom:4px;
    }
    .msg-container.user { flex-direction:row-reverse; align-self:flex-end; }
    .msg-container.ai { align-self:flex-start; }
    .avatar {
      width:32px;
      height:32px;
      border-radius:50%;
      margin:0 8px;
      background:#333;
      flex-shrink:0;
      object-fit:cover;
    }
    .msg {
      padding:10px 14px;
      border-radius:18px;
      font-size:15px;
      line-height:1.3;
      position:relative;
      word-wrap:break-word;
    }
    .user .msg {
      background:#007aff;
      color:#fff;
      border-bottom-right-radius:4px;
    }
    .ai .msg {
      background:#1c1c1e;
      color:#fff;
      border-bottom-left-radius:4px;
    }
    .time {
      font-size:11px;
      color:#888;
      margin-top:4px;
      text-align:right;
      align-self:flex-end;
    }
    .typing {
      align-self:flex-start;
      padding:10px 14px;
      background:#1c1c1e;
      border-radius:18px;
      width:fit-content;
      font-size:14px;
      color:#888;
    }
    #input-area {
      background:#1c1c1e;
      padding:10px 16px;
      display:flex;
      align-items:center;
      border-top:1px solid #333;
    }
    #input {
      flex:1;
      background:#2c2c2e;
      border:none;
      border-radius:20px;
      padding:12px 16px;
      color:#fff;
      font-size:16px;
      outline:none;
    }
    #send {
      background:#007aff;
      color:#fff;
      border:none;
      border-radius:50%;
      width:38px;
      height:38px;
      margin-left:12px;
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    /* N√∫t upload avatar */
    #upload-avatar {
      position: absolute;
      top: 10px;
      right: 60px;
      padding: 8px 12px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <div class="back"><</div>
    <div class="name">LiteOpt Chat</div>
    <button id="upload-avatar">Thay avatar AI</button>
  </header>

  <div id="chat"></div>

  <div id="input-area">
    <input id="input" type="text" placeholder="iMessage..." autocomplete="off"/>
    <button id="send">‚û§</button>
  </div>

  <input type="file" id="avatar-input" accept="image/*" style="display:none;">

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const uploadBtn = document.getElementById('upload-avatar');
    const avatarInput = document.getElementById('avatar-input');

    // API config (thay b·∫±ng c·ªßa b·∫°n)
    const API_KEY = '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'; // D√ÅN KEY TH·∫¨T V√ÄO ƒê√ÇY
    const API_URL = 'https://api.openrouter.ai/api/v1/chat/completions';
    const MODEL = 'openai/gpt-oss-safeguard-20b';

    // T√™n v√† t√≠nh c√°ch AI (prompt c·ªë ƒë·ªãnh, b·∫°n c√≥ th·ªÉ ch·ªânh)
    const AI_NAME = "LiteOpt AI";
    const AI_PERSONALITY = "B·∫°n l√† m·ªôt ng∆∞·ªùi b·∫°n th√¢n thi·∫øt, vui t√≠nh, hay d√πng emoji, n√≥i chuy·ªán t·ª± nhi√™n nh∆∞ bro, lu√¥n h·ªó tr·ª£ v√† hi·ªÉu t√¢m tr·∫°ng c·ªßa ng∆∞·ªùi d√πng. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Anh, ng·∫Øn g·ªçn, g·∫ßn g≈©i.";

    // L∆∞u l·ªãch s·ª≠ chat + avatar
    let messages = JSON.parse(localStorage.getItem('chatHistory')) || [
      { role: 'assistant', content: `Yo bro, ch√†o m·ª´ng ƒë·∫øn v·ªõi ${AI_NAME}! H√¥m nay kh·ªèe kh√¥ng? üòé` }
    ];

    let aiAvatar = localStorage.getItem('aiAvatar') || 'https://via.placeholder.com/32/1c1c1e/fff?text=AI';

    // Hi·ªÉn th·ªã l·ªãch s·ª≠ c≈©
    function loadHistory() {
      chat.innerHTML = '';
      messages.forEach(msg => {
        addMessage(msg.role, msg.content, true);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    function addMessage(role, content, isHistory = false) {
      const container = document.createElement('div');
      container.className = `msg-container ${role === 'user' ? 'user' : 'ai'}`;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      const img = document.createElement('img');
      img.src = role === 'user' ? 'https://via.placeholder.com/32/007aff/fff?text=You' : aiAvatar;
      img.alt = role === 'user' ? 'You' : AI_NAME;
      avatar.appendChild(img);

      const bubble = document.createElement('div');
      bubble.className = 'msg';
      bubble.textContent = content;

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      container.appendChild(avatar);
      container.appendChild(bubble);
      container.appendChild(time);

      chat.appendChild(container);
      if (!isHistory) chat.scrollTop = chat.scrollHeight;
    }

    loadHistory();

    async function sendMsg() {
      const text = input.value.trim();
      if (!text) return;

      addMessage('user', text);
      messages.push({ role: 'user', content: text });
      input.value = '';

      // Typing indicator
      const typingContainer = document.createElement('div');
      typingContainer.className = 'msg-container ai';
      const typingAvatar = document.createElement('div');
      typingAvatar.className = 'avatar';
      const typingImg = document.createElement('img');
      typingImg.src = aiAvatar;
      typingAvatar.appendChild(typingImg);
      const typingBubble = document.createElement('div');
      typingBubble.className = 'msg typing';
      typingBubble.innerHTML = 'ƒêang so·∫°n <span class="typing-dots">...</span>';
      typingContainer.appendChild(typingAvatar);
      typingContainer.appendChild(typingBubble);
      chat.appendChild(typingContainer);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json',
            'HTTP-Referer': window.location.href,
            'X-Title': 'LiteOpt Chat'
          },
          body: JSON.stringify({
            model: MODEL,
            messages: [
              { role: 'system', content: `T√™n b·∫°n l√† ${AI_NAME}. T√≠nh c√°ch: ${AI_PERSONALITY}` },
              ...messages
            ],
            temperature: 0.7,
            max_tokens: 1024
          })
        });

        if (!res.ok) throw new Error('API error: ' + res.status);

        const data = await res.json();
        if (!data.choices || !data.choices[0]) throw new Error('No response from API');

        const reply = data.choices[0].message.content.trim();

        typingContainer.remove();
        addMessage('assistant', reply);
        messages.push({ role: 'assistant', content: reply });

        localStorage.setItem('chatHistory', JSON.stringify(messages));
      } catch (err) {
        typingContainer.remove();
        addMessage('assistant', 'L·ªói r·ªìi bro: ' + err.message);
        console.error(err);
      }
    }

    sendBtn.onclick = sendMsg;
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMsg();
    });

    // Upload avatar cho AI
    uploadAvatar.addEventListener('click', () => avatarInput.click());
    avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = event => {
        aiAvatar = event.target.result;
        localStorage.setItem('aiAvatar', aiAvatar);
        // Reload chat ƒë·ªÉ c·∫≠p nh·∫≠t avatar m·ªõi
        loadHistory();
      };
      reader.readAsDataURL(file);
    });

    // N√∫t x√≥a l·ªãch s·ª≠
    const resetBtn = document.createElement('button');
    resetBtn.textContent = 'X√≥a l·ªãch s·ª≠';
    resetBtn.style.position = 'absolute';
    resetBtn.style.top = '10px';
    resetBtn.style.right = '10px';
    resetBtn.style.padding = '8px 16px';
    resetBtn.style.background = '#ff3b30';
    resetBtn.style.color = '#fff';
    resetBtn.style.border = 'none';
    resetBtn.style.borderRadius = '8px';
    resetBtn.style.cursor = 'pointer';
    document.body.appendChild(resetBtn);
    resetBtn.onclick = () => {
      localStorage.removeItem('chatHistory');
      localStorage.removeItem('aiAvatar');
      aiAvatar = 'https://via.placeholder.com/32/1c1c1e/fff?text=AI';
      messages = [{ role: 'assistant', content: 'L·ªãch s·ª≠ ƒë√£ x√≥a. Ch√†o bro!' }];
      loadHistory();
    };
  </script>
</body>
</html>
